<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ì„œê´€ ì¶œì„ ì²´í¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        '2xl': '1536px',
                        '3xl': '1920px',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-secondary {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-text-delete {
            color: #ef4444; /* red-500 */
        }
        .btn-text-delete:hover {
            text-decoration: underline;
        }
        /* Custom styles for circular button */
        .circular-btn {
            width: 64px; /* w-16 */
            height: 64px; /* h-16 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600; /* font-semibold */
            font-size: 1.125rem; /* text-lg */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            color: white; /* Text color for the button */
        }
        .circular-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .circular-btn:disabled {
            background-color: #9ca3af; /* gray-400 for disabled state */
            cursor: not-allowed;
            box-shadow: none;
        }
        /* Style for attendance history modal */
        .history-list-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .history-list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-stone-100 flex items-center justify-center min-h-screen p-4">

    <!-- FHD í•´ìƒë„ì— ë§ê²Œ ìµœëŒ€ ë„ˆë¹„ ì œí•œ í•´ì œ -->
    <main class="w-full bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-4">
        
        <!-- Date Display Section -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 text-stone-600">
            <div class="text-center sm:text-left mb-2 sm:mb-0">
                <p class="font-bold text-green-500 text-[70px]">ë„ì„œ ëŒ€ì¶œì¼</p>
                <div id="current-date" class="font-medium text-green-500 text-4xl sm:text-5xl lg:text-[70px] leading-none"></div>
            </div>
            <div class="text-center sm:text-right">
                <p class="font-bold text-orange-500 text-[70px]">ë„ì„œ ë°˜ë‚©ì¼</p>
                <div id="two-weeks-later-date" class="font-medium text-orange-500 text-4xl sm:text-5xl lg:text-[70px] leading-none"></div>
            </div>
        </div>

        <!-- Separator Line -->
        <div class="h-px bg-stone-300 my-4"></div>

        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-stone-800">ë„ì„œê´€ ì¶œì„ ì²´í¬ ğŸ§‘â€ğŸ“</h1>
            <p class="text-stone-500 mt-2">ìê¸° ì´ë¦„ì„ ì°¾ì•„ í´ë¦­ í•´ ì£¼ì„¸ìš”!</p>
        </header>

        <!-- Student List -->
        <!-- FHD í•´ìƒë„ì—ì„œ 3ì¤„ë¡œ í‘œì‹œë˜ë„ë¡ xl:grid-cols-11ë¡œ ìˆ˜ì • -->
        <section class="space-y-4">
            <h2 class="text-lg font-semibold text-stone-700 mb-2">í•™ìƒ ëª©ë¡ (ì´ <span id="student-count">0</span>ëª…)</h2>
            <div id="student-list-container" class="bg-white border border-stone-200 rounded-lg p-3 shadow-sm grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-11 gap-x-3 gap-y-1">
                <p id="no-students-message" class="col-span-full text-center text-stone-400 mt-4 hidden">ì•„ì§ ë“±ë¡ëœ í•™ìƒì´ ì—†ì–´ìš”. â¬†ï¸ ìœ„ì—ì„œ í•™ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                <!-- í•™ìƒ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </section>

        <footer class="text-center pt-2">
            <!-- ë¶ˆí•„ìš”í•œ ë²„íŠ¼ê³¼ flex ì»¨í…Œì´ë„ˆ ì œê±° -->
            <button id="reset-all-button" class="text-sm btn-text-delete hover:underline">
                ëª¨ë“  í•™ìƒ ê¸°ë¡ ì´ˆê¸°í™”
            </button>
        </footer>

    </main>

    <!-- ëª¨ë“  í•™ìƒ ê¸°ë¡ ì´ˆê¸°í™” ì½”ë“œ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="code-reset-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-stone-800">ì´ˆê¸°í™” ì½”ë“œ ì…ë ¥</h3>
            <p class="text-stone-500 mt-2 mb-4">ëª¨ë“  í•™ìƒ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ë ¤ë©´ 4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="reset-code-input" class="w-full p-2 border-2 border-stone-300 rounded-md text-center text-lg tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="4">
            <p id="code-error-message" class="text-red-500 text-sm mt-2 hidden">ì˜¬ë°”ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="confirm-code-button" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">í™•ì¸</button>
                <button id="cancel-code-button" class="px-6 py-2 rounded-lg font-semibold bg-stone-200 text-stone-700 hover:bg-stone-300">ì•„ë‹ˆìš”</button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë“  í•™ìƒ ê¸°ë¡ ì´ˆê¸°í™” ìµœì¢… í™•ì¸ ëª¨ë‹¬ -->
    <div id="reset-all-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-stone-800">ì •ë§ ëª¨ë“  í•™ìƒì„ ì´ˆê¸°í™”í•˜ì‹œê² ì–´ìš”?</h3>
            <p class="text-stone-500 mt-2 mb-6">ëª¨ë“  í•™ìƒì˜ ì¶œì„ ê¸°ë¡ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-reset-all-button" class="px-6 py-2 rounded-lg font-semibold btn-secondary">ë„¤, ì „ë¶€ ì´ˆê¸°í™”í•©ë‹ˆë‹¤</button>
                <button id="cancel-reset-all-button" class="px-6 py-2 rounded-lg font-semibold bg-stone-200 text-stone-700 hover:bg-stone-300">ì•„ë‹ˆìš”</button>
            </div>
        </div>
    </div>

    <!-- ì •ë³´ ë©”ì‹œì§€ ëª¨ë‹¬ (ì˜ˆ: 40ëª… ì œí•œ, ì´ë¦„ ì¤‘ë³µ) -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center">
            <h3 id="info-modal-title" class="text-xl font-bold text-stone-800">ì•Œë¦¼</h3>
            <p id="info-modal-text" class="text-stone-500 mt-2 mb-6">[ë©”ì‹œì§€ ë‚´ìš©]</p>
            <button id="close-info-modal-button" class="px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white">í™•ì¸</button>
        </div>
    </div>

    <!-- í•™ìƒ ì¶œì„ ê¸°ë¡ ëª¨ë‹¬ (ì‚­ì œí•˜ì§€ ì•ŠìŒ) -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center">
            <h3 id="history-modal-title" class="text-xl font-bold text-stone-800 mb-4">[í•™ìƒ ì´ë¦„] ì¶œì„ ê¸°ë¡</h3>
            <div id="history-list-container" class="h-64 bg-stone-50 border border-stone-200 rounded-lg p-3 overflow-y-auto text-left">
                <ul id="history-list" class="space-y-1 text-stone-600">
                    <!-- ì¶œì„ ê¸°ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </ul>
                <p id="no-history-message" class="text-center text-stone-400 mt-4 hidden">ì•„ì§ ì¶œì„ ê¸°ë¡ì´ ì—†ì–´ìš”.</p>
            </div>
            <button id="close-history-modal-button" class="mt-6 px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const studentListContainer = document.getElementById('student-list-container');
            const studentCountSpan = document.getElementById('student-count');
            const noStudentsMessage = document.getElementById('no-students-message');
            const resetAllButton = document.getElementById('reset-all-button');

            const codeResetModal = document.getElementById('code-reset-modal');
            const resetCodeInput = document.getElementById('reset-code-input');
            const confirmCodeButton = document.getElementById('confirm-code-button');
            const cancelCodeButton = document.getElementById('cancel-code-button');
            const codeErrorMessage = document.getElementById('code-error-message');

            const resetAllModal = document.getElementById('reset-all-modal');
            const confirmResetAllButton = document.getElementById('confirm-reset-all-button');
            const cancelResetAllButton = document.getElementById('cancel-reset-all-button');

            const infoModal = document.getElementById('info-modal');
            const infoModalTitle = document.getElementById('info-modal-title');
            const infoModalText = document.getElementById('info-modal-text');
            const closeInfoModalButton = document.getElementById('close-info-modal-button');

            const historyModal = document.getElementById('history-modal');
            const historyModalTitle = document.getElementById('history-modal-title');
            const historyList = document.getElementById('history-list');
            const noHistoryMessage = document.getElementById('no-history-message');
            const closeHistoryModalButton = document.getElementById('close-history-modal-button');
            
            const currentDateEl = document.getElementById('current-date');
            const twoWeeksLaterDateEl = document.getElementById('two-weeks-later-date');

            let students = {}; // í•™ìƒ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´. ì˜ˆ: { 'í•™ìƒì´ë¦„': { attendanceDates: ['YYYYë…„ MMì›” DDì¼ (ìš”ì¼) HHì‹œ MMë¶„ SSì´ˆ'] } }
            let studentOrder = []; // í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•œ ìˆœì„œëŒ€ë¡œ ì €ì¥í•  ë°°ì—´

            let currentStudentNameToOperate = null;
            let draggedStudentName = null;
            
            // ê³ ì •ëœ í•™ìƒ ëª©ë¡
            const fixedStudentNames = [
                'ì •í•´ë‚˜', 'ì›ì†Œì •', 'ìš°ì°¬ì˜', 'ì „ì œì¤€', 'ê°•í•œë´„', 'ì´ê¸°ì›…', 'ìš©í•´ì¸', 'ì´íš¨ìœ¨',
                'ì¥ì„¤', 'ì´í•˜ìœ¤', 'ê³½ì¬ì€', 'ê¹€íƒœì´', 'ê°•ì‹œí˜¸', 'ì •ëª¨ì„¸', 'ê¹€ë„í¬', 'ê¹€ë¼ì—˜',
                'ì´ê¸°ë°±', 'ì´ê±´ìš°', 'ê¹€ë‹¤ì¸', 'ê¹€ë„ì¤€', 'ì‹ ì§€ìš°', 'í•œì¬ì´', 'ì‹ ìˆ˜ë¹ˆ', 'ë°•ì§€ìœ ',
                'ê¶Œë„ì—°', 'ìš°ì˜ˆë¹ˆ', 'ê¹€ë„í›ˆ', 'ì°¨íƒœí˜¸', 'ë°•ê²½ë¯¼', 'ê¶Œë‚˜ìœ¤', 'ê°•í•œì•„'
            ];

            // í•™ìƒ ì¹´ë“œ ë°°ê²½ìƒ‰ íŒ”ë ˆíŠ¸ (Tailwind CSS í´ë˜ìŠ¤)
            const studentCardColors = [
                'bg-blue-50', 'bg-green-50', 'bg-yellow-50', 'bg-red-50',
                'bg-purple-50', 'bg-pink-50', 'bg-indigo-50', 'bg-teal-50',
            ];

            // ì¶œì„ ë²„íŠ¼ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (Tailwind CSS í´ë˜ìŠ¤), ìœ„ì˜ ì¹´ë“œ ìƒ‰ìƒì— ëŒ€ì‘
            const circularButtonColors = [
                'bg-blue-600', 'bg-green-600', 'bg-yellow-600', 'bg-red-600',
                'bg-purple-600', 'bg-pink-600', 'bg-indigo-600', 'bg-teal-600',
            ];
            
            const getFormattedDateString = (date, includeYear = true, includeTime = false) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const daysOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                const dayOfWeek = daysOfWeek[date.getDay()];
                
                let dateString = '';
                if (includeYear) {
                    dateString += `${year}ë…„ `;
                }
                dateString += `${month}ì›” ${day}ì¼ (${dayOfWeek})`;

                if (includeTime) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    dateString += ` ${hours}ì‹œ ${minutes}ë¶„ ${seconds}ì´ˆ`;
                }
                return dateString;
            };

            const getReturnDate = () => {
                let date = new Date();
                date.setDate(date.getDate() + 14); // ì˜¤ëŠ˜ë¡œë¶€í„° 14ì¼ í›„

                let dayOfWeek = date.getDay(); // 0: ì¼ìš”ì¼, 6: í† ìš”ì¼

                if (dayOfWeek === 0) { // ì¼ìš”ì¼ì´ë©´
                    date.setDate(date.getDate() + 1); // ë‹¤ìŒ ì›”ìš”ì¼ë¡œ
                } else if (dayOfWeek === 6) { // í† ìš”ì¼ì´ë©´
                    date.setDate(date.getDate() + 2); // ë‹¤ìŒ ì›”ìš”ì¼ë¡œ
                }
                return getFormattedDateString(date, false); // ë°˜ë‚©ì¼ì€ ë…„ë„ ì œì™¸
            };

            const loadData = () => {
                const savedData = localStorage.getItem('attendanceAppStudents');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    students = parsedData.students || {};
                    studentOrder = parsedData.studentOrder || [...fixedStudentNames];
                } else {
                    studentOrder = [...fixedStudentNames];
                    fixedStudentNames.forEach(name => {
                        students[name] = { attendanceDates: [] };
                    });
                }
                const currentStudentNamesInOrder = new Set(studentOrder);
                const studentsToDelete = Object.keys(students).filter(name => !currentStudentNamesInOrder.has(name));
                studentsToDelete.forEach(name => delete students[name]);

                fixedStudentNames.forEach(name => {
                    if (!students[name]) {
                        students[name] = { attendanceDates: [] };
                    }
                });
                studentOrder = studentOrder.filter(name => fixedStudentNames.includes(name));
                fixedStudentNames.forEach(name => {
                    if (!studentOrder.includes(name)) {
                        studentOrder.push(name);
                    }
                });
            };

            const saveData = () => {
                const dataToSave = {
                    students: students,
                    studentOrder: studentOrder,
                };
                localStorage.setItem('attendanceAppStudents', JSON.stringify(dataToSave));
            };

            const showInfoModal = (title, message) => {
                infoModalTitle.textContent = title;
                infoModalText.textContent = message;
                infoModal.classList.remove('hidden');
            };

const renderStudents = () => {
                studentListContainer.innerHTML = '';
                studentCountSpan.textContent = studentOrder.length;

                if (studentOrder.length === 0) {
                    noStudentsMessage.classList.remove('hidden');
                    noStudentsMessage.className = 'col-span-full text-center text-stone-400 mt-4';
                    studentListContainer.appendChild(noStudentsMessage);
                } else {
                    noStudentsMessage.classList.add('hidden');
                }

                const currentMonthYear = new Date().getFullYear() + 'ë…„ ' + String(new Date().getMonth() + 1).padStart(2, '0') + 'ì›”';
                
                const monthlyAttendanceCounts = studentOrder.map(studentName => {
                    const student = students[studentName];
                    const uniqueMonthlyAttendanceDates = new Set(
                        student.attendanceDates
                            .filter(date => date.startsWith(currentMonthYear))
                            .map(date => date.split(' (')[0]) // YYYYë…„ MMì›” DDì¼ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì‹œê°„ ì œì™¸)
                    );
                    return { name: studentName, count: uniqueMonthlyAttendanceDates.size };
                });

                monthlyAttendanceCounts.sort((a, b) => b.count - a.count);

                let topStudents = new Set();
                if (monthlyAttendanceCounts.length > 0) {
                    const topCount = monthlyAttendanceCounts[0].count;
                    monthlyAttendanceCounts.forEach(student => {
                        if (student.count === topCount && topCount > 0) {
                            topStudents.add(student.name);
                        }
                    });
                }
                
                studentOrder.forEach((studentName, index) => {
                    const student = students[studentName];
                    if (!student) {
                        students[studentName] = { attendanceDates: [] };
                    }

                    // ì¶œì„ ì—¬ë¶€ í™•ì¸ ë¡œì§ ìˆ˜ì •: YYYYë…„ MMì›” DDì¼ ë¶€ë¶„ë§Œ ë¹„êµ
                    const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0]; 
                    const hasAttendedToday = students[studentName].attendanceDates.some(date => date.startsWith(todayDateOnly));

                    // ì¶œì„ íšŸìˆ˜ ì§‘ê³„ ë¡œì§ ìˆ˜ì •: YYYYë…„ MMì›” DDì¼ ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ìœ ì¼í•œ ë‚ ì§œ ìˆ˜ë¥¼ ê³„ì‚°
                    const uniqueMonthlyAttendanceDates = new Set(
                        students[studentName].attendanceDates
                            .filter(date => date.startsWith(currentMonthYear))
                            .map(date => date.split(' (')[0])
                    );
                    const attendedCount = uniqueMonthlyAttendanceDates.size;

                    const cardColorClass = studentCardColors[index % studentCardColors.length];
                    const buttonColorClass = circularButtonColors[index % circularButtonColors.length];

                    const isTopStudent = topStudents.has(studentName);
                    const crownIcon = isTopStudent ? ' ğŸ‘‘' : '';

                    const studentCard = document.createElement('div');
                    studentCard.className = `${cardColorClass} p-4 rounded-lg border border-stone-200 shadow-sm flex flex-col items-center justify-between cursor-grab`;
                    studentCard.setAttribute('data-student-name', studentName);
                    studentCard.setAttribute('draggable', 'true');

                    studentCard.innerHTML = `
                        <div class="flex items-center justify-between w-full mb-3">
                            <h3 class="text-xl font-semibold text-stone-800 truncate pr-4">${studentName}${crownIcon}</h3>
                            </div>
                        <div class="flex flex-col items-center space-y-2">
                            <button class="circular-btn attend-btn ${hasAttendedToday ? 'bg-gray-400 cursor-not-allowed' : buttonColorClass}" ${hasAttendedToday ? 'disabled' : ''} data-student-name="${studentName}">
                                ${hasAttendedToday ? 'ì™„ë£Œ! ğŸ‰' : 'ì¶œì„'}
                            </button>
                            <div class="text-center text-base mt-2">
                                <p class="text-stone-500 text-sm">ì´ë²ˆ ë‹¬ ì¶œì„ íšŸìˆ˜</p>
                                <p class="text-xl font-bold text-blue-600">${attendedCount}íšŒ</p>
                                ${hasAttendedToday ? `<button class="text-sm text-blue-500 hover:text-blue-700 hover:underline undo-attend-btn mt-1" data-student-name="${studentName}">ë˜ëŒë¦¬ê¸°</button>` : ''}
                            </div>
                        </div>
                    `;
                    studentListContainer.appendChild(studentCard);
                });

                attachStudentButtonListeners();
                attachDragAndDropListeners();
            };

            const attachStudentButtonListeners = () => {
                document.querySelectorAll('.attend-btn').forEach(button => {
                    button.onclick = (event) => {
                        const studentName = event.target.dataset.studentName;
                        const fullTodayStrWithTime = getFormattedDateString(new Date(), true, true); // YYYYë…„ MMì›” DDì¼ (ìš”ì¼) HHì‹œ MMë¶„ SSì´ˆ
                        const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0]; // YYYYë…„ MMì›” DDì¼ ë¶€ë¶„
                        
                        if (students[studentName]) {
                            const hasAttendedToday = students[studentName].attendanceDates.some(date => date.startsWith(todayDateOnly));

                            if (hasAttendedToday) {
                                showInfoModal('ì´ë¯¸ ì¶œì„ ì™„ë£Œ', 'ì´ í•™ìƒì€ ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„í–ˆìŠµë‹ˆë‹¤.');
                                return;
                            }

                            students[studentName].attendanceDates.push(fullTodayStrWithTime);
                            saveData();
                            renderStudents();
                        }
                    };
                });
                
                document.querySelectorAll('.undo-attend-btn').forEach(button => {
                    button.onclick = (event) => {
                        const studentName = event.target.dataset.studentName;
                        const todayDateOnly = getFormattedDateString(new Date(), true, false).split(' (')[0]; // YYYYë…„ MMì›” DDì¼ ë¶€ë¶„

                        if (students[studentName]) {
                            let lastIndex = -1;
                            for (let i = students[studentName].attendanceDates.length - 1; i >= 0; i--) {
                                if (students[studentName].attendanceDates[i].startsWith(todayDateOnly)) {
                                    lastIndex = i;
                                    break;
                                }
                            }
                            
                            if (lastIndex > -1) {
                                students[studentName].attendanceDates.splice(lastIndex, 1);
                                saveData();
                                renderStudents();
                            }
                        }
                    };
                });
            };

            const attachDragAndDropListeners = () => {
                const studentCards = studentListContainer.querySelectorAll('[draggable="true"]');

                studentCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        draggedStudentName = card.dataset.studentName;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', draggedStudentName);
                        setTimeout(() => {
                            card.classList.add('opacity-50', 'border-dashed', 'border-blue-500');
                        }, 0);
                    });

                    card.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        const targetCard = e.currentTarget;
                        if (draggedStudentName !== targetCard.dataset.studentName) {
                            targetCard.classList.add('border-2', 'border-blue-300', 'scale-105');
                        }
                    });

                    card.addEventListener('dragleave', (e) => {
                        e.currentTarget.classList.remove('border-2', 'border-blue-300', 'scale-105');
                    });

                    card.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const droppedOnStudentName = e.currentTarget.dataset.studentName;

                        if (draggedStudentName && droppedOnStudentName && draggedStudentName !== droppedOnStudentName) {
                            const fromIndex = studentOrder.indexOf(draggedStudentName);
                            const toIndex = studentOrder.indexOf(droppedOnStudentName);

                            if (fromIndex > -1 && toIndex > -1) {
                                const [movedItem] = studentOrder.splice(fromIndex, 1);
                                studentOrder.splice(toIndex, 0, movedItem);
                                saveData();
                                renderStudents();
                            }
                        }
                    });

                    card.addEventListener('dragend', (e) => {
                        studentCards.forEach(c => c.classList.remove('opacity-50', 'border-dashed', 'border-blue-500', 'border-2', 'border-blue-300', 'scale-105'));
                        draggedStudentName = null;
                    });
                });
            };

            resetAllButton.addEventListener('click', () => {
                codeResetModal.classList.remove('hidden');
                resetCodeInput.value = '';
                codeErrorMessage.classList.add('hidden');
            });

            confirmCodeButton.addEventListener('click', () => {
                const enteredCode = resetCodeInput.value;
                if (enteredCode === '6408') {
                    codeResetModal.classList.add('hidden');
                    resetAllModal.classList.remove('hidden');
                } else {
                    codeErrorMessage.classList.remove('hidden');
                    resetCodeInput.value = '';
                }
            });

            cancelCodeButton.addEventListener('click', () => {
                codeResetModal.classList.add('hidden');
            });

            confirmResetAllButton.addEventListener('click', () => {
                students = {};
                studentOrder = [...fixedStudentNames];
                fixedStudentNames.forEach(name => {
                    students[name] = { attendanceDates: [] };
                });
                saveData();
                renderStudents();
                resetAllModal.classList.add('hidden');
            });

            cancelResetAllButton.addEventListener('click', () => {
                resetAllModal.classList.add('hidden');
            });

            closeInfoModalButton.addEventListener('click', () => {
                infoModal.classList.add('hidden');
            });
            
            // ì›”ë³„ ì¶œì„ í˜„í™© ê´€ë ¨ ëª¨ë‹¬ê³¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            const monthlyStatsModal = document.getElementById('monthly-stats-modal');
            const monthlyStatsContent = document.getElementById('monthly-stats-content');
            const closeMonthlyStatsButton = document.getElementById('close-monthly-stats-button');
            const monthlyStatsButton = document.getElementById('monthly-stats-button');

            // ì›”ë³„ í†µê³„ ê´€ë ¨ ì½”ë“œëŠ” ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë„ ì œê±°í•©ë‹ˆë‹¤.
            if(monthlyStatsButton) {
                monthlyStatsButton.onclick = () => { showInfoModal('ê¸°ëŠ¥ ì œê±°', 'ì´ ê¸°ëŠ¥ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.'); };
            }
            if(closeMonthlyStatsButton) {
                closeMonthlyStatsButton.onclick = () => { monthlyStatsModal.classList.add('hidden'); };
            }


            currentDateEl.textContent = getFormattedDateString(new Date(), false);
            twoWeeksLaterDateEl.textContent = getReturnDate();

            loadData();
            renderStudents();
        });
    </script>
</body>
</html>
